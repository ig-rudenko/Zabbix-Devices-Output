import pexpect
from re import findall, sub
import os
import sys
import textfsm
from func.intf_view import interface_normal_view

root_dir = os.path.join(os.getcwd(), os.path.split(sys.argv[0])[0])


def show_mac_huawei_1(telnet_session, output: list, interface_filter: str) -> str:
    intf_to_check = []  # –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    mac_output = ''  # –í—ã–≤–æ–¥ MAC
    not_uplinks = True if interface_filter == '--only-abonents' else False

    for line in output:
        if (
                (not not_uplinks and bool(findall(interface_filter, line[3])))  # –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –ø–æ —Ñ–∏–ª—å—Ç—Ä—É
                or (not_uplinks and  # –ò–õ–ò –≤—Å–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã, –∫—Ä–æ–º–µ:
                    'SVSL' not in line[3].upper() and  # - –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–¥–µ—Ä–∂–∞—Ç "SVSL"
                    'HUAWEI, QUIDWAY' not in line[3].upper() and  # - "–∑–∞–≥–ª—É—à–µ–∫" —Ç–∏–ø–∞ "HUAWEI, Quidway Series
                    'POWER_MONITORING' not in line[3].upper())  # - POWER_MONITORING
                and 'down' not in line[1].lower()  # –ò —Ç–æ–ª—å–∫–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º admin up
        ):  # –ï—Å–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤ —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—è–µ—Ç —Ñ–∏–ª—å—Ç—Ä—É
            intf_to_check.append([line[0], line[3]])

    if not intf_to_check:
        if not_uplinks:
            return '–ü–æ—Ä—Ç—ã –∞–±–æ–Ω–µ–Ω—Ç–æ–≤ –Ω–µ –±—ã–ª–∏ –Ω–∞–π–¥–µ–Ω—ã –ª–∏–±–æ –∏–º–µ—é—Ç —Å—Ç–∞—Ç—É—Å admin down (–≤ —ç—Ç–æ–º —Å–ª—É—á–∞–µ MAC\'–æ–≤ –Ω–µ—Ç)'
        else:
            return f'–ù–∏ –æ–¥–∏–Ω –∏–∑ –ø–æ—Ä—Ç–æ–≤ –Ω–µ –ø—Ä–æ—à–µ–ª –ø—Ä–æ–≤–µ—Ä–∫—É —Ñ–∏–ª—å—Ç—Ä–∞ "{interface_filter}" ' \
                   f'–ª–∏–±–æ –∏–º–µ–µ—Ç —Å—Ç–∞—Ç—É—Å admin down (–≤ —ç—Ç–æ–º —Å–ª—É—á–∞–µ MAC\'–æ–≤ –Ω–µ—Ç)'

    for intf in intf_to_check:  # –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        telnet_session.sendline(f'display mac-address {interface_normal_view(intf[0])}')
        telnet_session.expect(f'{interface_normal_view(intf[0])}')
        mac_output += f'\n    –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å: {interface_normal_view(intf[1])}\n'
        while True:
            match = telnet_session.expect([r'<', "  ---- More ----", pexpect.TIMEOUT])
            page = str(telnet_session.before.decode('utf-8'))
            mac_output += page.strip()
            if match == 0:
                break
            elif match == 1:
                telnet_session.send(" ")
                mac_output += '\n'
            else:
                print("    –û—à–∏–±–∫–∞: timeout")
                break
        mac_output += '\n'
    return mac_output


def show_mac_huawei_2(telnet_session, output: list, interface_filter: str) -> str:
    intf_to_check = []  # –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    mac_output = ''  # –í—ã–≤–æ–¥ MAC
    # –í—Å–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã, –∫—Ä–æ–º–µ –∞–ø–ª–∏–Ω–∫–æ–≤
    not_uplinks = True if interface_filter == '--only-abonents' else False

    for line in output:
        if (
                (not not_uplinks and bool(findall(interface_filter, line[2])))  # –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –ø–æ —Ñ–∏–ª—å—Ç—Ä—É
                or (not_uplinks and                          # –ò–õ–ò –≤—Å–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã, –∫—Ä–æ–º–µ:
                    'SVSL' not in line[2].upper() and             # - –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–¥–µ—Ä–∂–∞—Ç "SVSL"
                    'HUAWEI, QUIDWAY' not in line[2].upper() and  # - "–∑–∞–≥–ª—É—à–µ–∫" —Ç–∏–ø–∞ "HUAWEI, Quidway Series
                    'POWER_MONITORING' not in line[2].upper())    # - POWER_MONITORING
                and 'down' not in line[1].lower()            # –ò —Ç–æ–ª—å–∫–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º admin up
        ):  # –ï—Å–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤ —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—è–µ—Ç —Ñ–∏–ª—å—Ç—Ä—É
            intf_to_check.append([line[0], line[2]])

    if not intf_to_check:
        if not_uplinks:
            return '–ü–æ—Ä—Ç—ã –∞–±–æ–Ω–µ–Ω—Ç–æ–≤ –Ω–µ –±—ã–ª–∏ –Ω–∞–π–¥–µ–Ω—ã –ª–∏–±–æ –∏–º–µ—é—Ç —Å—Ç–∞—Ç—É—Å admin down (–≤ —ç—Ç–æ–º —Å–ª—É—á–∞–µ MAC\'–æ–≤ –Ω–µ—Ç)'
        else:
            return f'–ù–∏ –æ–¥–∏–Ω –∏–∑ –ø–æ—Ä—Ç–æ–≤ –Ω–µ –ø—Ä–æ—à–µ–ª –ø—Ä–æ–≤–µ—Ä–∫—É —Ñ–∏–ª—å—Ç—Ä–∞ "{interface_filter}" ' \
                   f'–ª–∏–±–æ –∏–º–µ–µ—Ç —Å—Ç–∞—Ç—É—Å admin down (–≤ —ç—Ç–æ–º —Å–ª—É—á–∞–µ MAC\'–æ–≤ –Ω–µ—Ç)'

    for intf in intf_to_check:  # –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        telnet_session.sendline(f'display mac-address interface {interface_normal_view(intf[0])}')
        telnet_session.expect(f'{interface_normal_view(intf[0])}')
        separator_str = '‚îÄ' * len(f'–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å: {interface_normal_view(intf[1])}')
        mac_output += f'\n    –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å: {interface_normal_view(intf[1])}\n    {separator_str}\n'
        while True:
            match = telnet_session.expect(['  ---  ', "  ---- More ----", pexpect.TIMEOUT])
            page = str(telnet_session.before.decode('utf-8'))
            mac_output += page.strip()
            if match == 0:
                break
            elif match == 1:
                telnet_session.send(" ")
                mac_output += '\n'
            else:
                print("    –û—à–∏–±–∫–∞: timeout")
                break
        mac_output += '\n\n'
    return mac_output


def show_interfaces(telnet_session) -> tuple:
    telnet_session.sendline("dis int des")
    output = ''
    huawei_type = 'huawei-1'
    template_type = ''
    while True:
        match = telnet_session.expect(['Too many parameters', ']', "  ---- More ----",
                               "Unrecognized command", ">", pexpect.TIMEOUT])
        output += str(telnet_session.before.decode('utf-8')).replace(
            "\x1b[42D                                          \x1b[42D", '').replace("[42D", '').strip()
        if match == 4:
            break
        elif match == 1:
            break
        elif match == 2:
            telnet_session.send(" ")
            output += '\n\n'
        elif match == 0 or match == 3:
            telnet_session.expect('>')
            telnet_session.sendline('super')
            telnet_session.expect(':')
            telnet_session.sendline('sevaccess')
            telnet_session.expect('>')
            telnet_session.sendline('dis brief int')
            output = ''
            huawei_type = 'huawei-2'
            template_type = '2'
        else:
            print("    –û—à–∏–±–∫–∞: timeout")
            break

    with open(f'{root_dir}/templates/int_des_huawei{template_type}.template', 'r') as template_file:
        int_des_ = textfsm.TextFSM(template_file)
        result = int_des_.ParseText(output)  # –ò—â–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã
    return result, huawei_type
